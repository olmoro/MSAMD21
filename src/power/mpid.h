#ifndef _MPID_H_
#define _MPID_H_
/*
  A fixed point PID controller with a 32-bit internal
  calculation pipeline.
  From:
  https://github.com/mike-matera/FastPID/tree/master/examples/VoltageRegulator
  FastPID: A fast 32-bit fixed-point PID controller for Arduino

    –†–µ–≥—É–ª—è—Ç–æ—Ä –æ–ø–µ—Ä–∏—Ä—É–µ—Ç —Å –ø—Ä–µ–¥–≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–º–∏ —Ü–µ–ª–æ—á–∏—Å–ª–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏. –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∫–∞–∫ –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å
  –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö –≤–æ–∑–ª–∞–≥–∞–µ—Ç—Å—è –Ω–∞ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä.
    –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã kp, ki, kd –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω—ã –ø–æ —Ñ–æ—Ä–º—É–ª–∞–º:
        kp * param_mult
        ki * param_mult / hz
        kd * param_mult * hz
    –≥–¥–µ param_mult - –º–Ω–æ–∂–∏—Ç–µ–ª—å, —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–π –∏–∑ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞–º–∏
  –≤–µ–ª–∏—á–∏–Ω param_shift –∏ param_bits. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é param_mult = 0x0100.
  –ü–∞—Ä–∞–º–µ—Ç—Ä param_bits –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ 1...16.
  –ü–∞—Ä–∞–º–µ—Ç—Ä hz –≤ –¥–∞–Ω–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –≤—Å–µ–≥–¥–∞ 10–≥—Ü.
    –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ minOut –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ maxOut –∑–Ω–∞—á–µ–Ω–∏—è –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞ –≤–æ–∑–ª–æ–∂–µ–Ω–æ
  –Ω–∞ –¥–∞–Ω–Ω—ã–π —Ä–µ—Å—É—Ä—Å –∏—Å—Ö–æ–¥—è –∏–∑ param_bits –∏ signOut.  –æ—Ç–º–µ–Ω–µ–Ω–æ
    –ê–ª–≥–æ—Ä–∏—Ç–º—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ–ø—É—Å—Ç–∏–º–æ—Å—Ç–∏ –≤–µ–ª–∏—á–∏–Ω –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç—Å—è –≤–∑—è—Ç—å –∏–∑ –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞ –æ—Ç mike-matera.

  –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ —É–ø—Ä–∞–≤–ª—è—é—Ç –º–µ–¥–ª–µ–Ω–Ω–æ –¥–≤–∏–∂—É—â–∏–º–∏—Å—è —Å–∏—Å—Ç–µ–º–∞–º–∏ –∏ –∏–º–µ—é—Ç –Ω–µ–Ω—É–ª–µ–≤–æ–π –∏–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω—ã–π —á–ª–µ–Ω,
  —á–∞—Å—Ç–æ –≤–∏–¥—è—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ. –≠—Ç–æ –≤—ã–∑–≤–∞–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω–æ–π —Å—É–º–º–æ–π winidng up,
  –ø–æ—Å–∫–æ–ª—å–∫—É –æ–Ω–∞ –ø–æ–º–Ω–∏—Ç –¥–æ–ª–≥–æ–µ –≤—Ä–µ–º—è –≤–¥–∞–ª–∏ –æ—Ç –∑–∞–¥–∞–Ω–Ω–æ–π —Ç–æ—á–∫–∏. –ï—Å–ª–∏ —ç—Ç–æ –æ–ø–∏—Å—ã–≤–∞–µ—Ç –≤–∞—à—É —Å–∏—Å—Ç–µ–º—É
  –µ—Å—Ç—å –¥–≤–µ –≤–µ—â–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –º–æ–∂–µ—Ç–µ —Å–¥–µ–ª–∞—Ç—å. 
  1. –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å —Å—É–º–º—É 
  –ï—Å—Ç—å –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É—é—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º—ã–π –ò–Ω—Ç–µ–≥—Ä–∞–ª. –ü–æ–Ω–∏–∂–µ–Ω–∏–µ —ç—Ç–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
  –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –≤—ã—Ö–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –∏–∑ —Å—Ç—Ä–æ—è. –ó–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∫–∞–∫ –º–æ–∂–Ω–æ –±–æ–ª—å—à–µ–≥–æ —Å–º–µ—â–µ–Ω–∏—è –æ—Ç –∑–∞–¥–∞–Ω–Ω–æ–≥–æ
  –∑–Ω–∞—á–µ–Ω–∏—è –∏ –ø–æ–∑–≤–æ–ª–∏—Ç —É–º–µ–Ω—å—à–∏—Ç—å –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ. 
  –ú–µ–Ω—è–π—Ç–µ —ç—Ç–∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã —Å –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å—é. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏—Ö —Å–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–æ –∏—Å–ø—Ä–∞–≤–∏—Ç –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É
  –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏, –Ω–æ —ç—Ç–æ –Ω–µ–≥–∞—Ç–∏–≤–Ω–æ —Å–∫–∞–∂–µ—Ç—Å—è –Ω–∞ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Ä–µ–≥—É–ª—è—Ç–æ—Ä–∞ —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É.
  –ï—Å–ª–∏ –≤—ã –Ω–µ —É–≤–µ—Ä–µ–Ω—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–æ–Ω—Å—Ç–∞–Ω—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ª–µ–¥—É—é—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Å—É–º–º—ã.
  2.



  
       –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞ Kp
    –î–ª—è –Ω–∞—á–∞–ª–∞ —è —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç Kp –≤ 1 –∏ —Å–º–æ—Ç—Ä—é, —á—Ç–æ –±—É–¥–µ—Ç. –†–∞—Å—Ç–µ—Ç —Å–ª–∏—à–∫–æ–º –º–µ–¥–ª–µ–Ω–Ω–æ ‚Äì
    —É–≤–µ–ª–∏—á–∏–≤–∞—é. –í –∫–∞–∫–æ–π-—Ç–æ –º–æ–º–µ–Ω—Ç –Ω–∞—á–Ω—É—Ç—Å—è –ø–µ—Ä–µ–ª–µ—Ç—ã –∏ –∫–æ–ª–µ–±–∞–Ω–∏—è. –ó–Ω–∞—á–∏—Ç, –º–Ω–æ–≥–æ–≤–∞—Ç–æ ‚Äì —É–º–µ–Ω—å—à–∞–µ–º. 
    –ò—Å—á–µ–∑–ª–∏ ‚Äì –Ω–µ–º–Ω–æ–≥–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º. –ù–∞—á–∞–ª–∏—Å—å ‚Äì –Ω–µ–º–Ω–æ–≥–æ —É–º–µ–Ω—å—à–∞–µ–º. –ò—Å—á–µ–∑–ª–∏ ‚Äî ‚Ä¶ –ò —Ç–∞–∫ –¥–∞–ª–µ–µ, –ø–æ–∫–∞ 
    –Ω–µ –Ω–∞–¥–æ–µ—Å—Ç. –í –∏—Ç–æ–≥–µ –ø–æ–ª—É—á–∏–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —É—Å—Ç–æ–π—á–∏–≤—ã–π –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ä–µ–≥—É–ª—è—Ç–æ—Ä, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞–¥–æ 
    –Ω–µ–º–Ω–æ–≥–æ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å (–Ω–∞–¥–æ –ª–∏? –ï—Å–ª–∏ –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–ø–æ–ª–Ω–µ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ, —Ç–æ –Ω–µ –º–æ—Ä–æ—á–∏–º —Å–µ–±–µ 
    –≥–æ–ª–æ–≤—É –∏ —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ)

        –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞ Kd
    –ü–æ–Ω–µ–º–Ω–æ–≥—É –Ω–∞—Ä–∞—â–∏–≤–∞—é –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç Kd ‚Äî 0.5, 1,‚Ä¶ –ö–æ–ª–µ–±–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã —É–º–µ–Ω—å—à–∞—é—Ç—Å—è, –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
    –∫—Ä–∞—Å–∏–≤–µ–µ‚Ä¶ –ü–æ–∫–∞ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –æ–±—Ä–∞—Ç–Ω–æ–µ ‚Äì –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è –º–æ—â–Ω—ã–µ –≤—ã–±—Ä–æ—Å—ã. –í—Å–µ, –ø–µ—Ä–µ—Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞–ª–∏, 
    —É–º–µ–Ω—å—à–∞–µ–º. –ò—Ç–∞–∫, –∏–º–µ–µ–º –≤—ã–±—Ä–æ—Å—ã ‚Äì —É–∂–µ –º–µ–Ω—å—à–µ, –Ω–æ –≤—Å–µ —Ä–∞–≤–Ω–æ –∏–º–µ–µ–º. –°–∞–º–æ–µ —Ç–æ —Å–≥–ª–∞–¥–∏—Ç—å, 
    –ø—Ä–∏—Ç–æ—Ä–º–æ–∑–∏—Ç—å –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ!

        –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω–æ–≥–æ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞ Ki
    –®–∞–º–∞–Ω–∏–º –¥–∞–ª—å—à–µ. –ë–µ—Ä–µ–º —Å–æ–≤—Å–µ–º –Ω–µ–º–Ω–æ–≥–æ ‚Äì 0.1 –¥–ª—è –Ω–∞—á–∞–ª–∞. –ú–æ–∂–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∏ –Ω–µ–±–æ–ª—å—à–æ–µ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ 
    –∑–Ω–∞—á–µ–Ω–∏–µ. –°–º–æ—Ç—Ä–∏–º, –ø—Ä–æ–±—É–µ–º, –∫—Ä—É—Ç–∏–º‚Ä¶ –ü—Ä–æ—Ü–µ—Å—Å —ç—Ç–æ—Ç ‚Äì –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Äì –∏—Ç–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π. –°—Ç–æ–∏—Ç –ø—Ä–æ–±–æ–≤–∞—Ç—å 
    —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã, –Ω–∞—á–∏–Ω–∞—Ç—å —Å–Ω–∞—á–∞–ª–∞. –î–ª—è –º–µ–Ω—è –æ–Ω –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É —Ç—É–º–∞–Ω–µ–Ω –∏ —à–∞–π—Ç–∞–Ω–µ–Ω.
 
  https://microtechnics.ru/nastrojka-koefficientov-pid-regulyatora/
  –ú–µ—Ç–æ–¥ –¶–∏–≥–ª–µ—Ä–∞-–ù–∏–∫–æ–ª—å—Å–∞.
  ‚óæ–î–ª—è –Ω–∞—á–∞–ª–∞ –æ–±–Ω—É–ª—è–µ–º –≤—Å–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã —Ä–µ–≥—É–ª—è—Ç–æ—Ä–∞ (–ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π, –∏–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω—ã–π –∏ –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π)
‚óæ–ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –Ω–∞—á–∏–Ω–∞–µ–º —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∏ —Å–ª–µ–¥–∏–º –∑–∞ —Ä–µ–∞–∫—Ü–∏–µ–π —Å–∏—Å—Ç–µ–º—ã. 
 –ü—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–º –∑–Ω–∞—á–µ–Ω–∏–∏ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –Ω–µ–∑–∞—Ç—É—Ö–∞—é—â–∏–µ –∫–æ–ª–µ–±–∞–Ω–∏—è —Ä–µ–≥—É–ª–∏—Ä—É–µ–º–æ–π –≤–µ–ª–∏—á–∏–Ω—ã.
‚óæ–§–∏–∫—Å–∏—Ä—É–µ–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç K, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–º —ç—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ. –ö—Ä–æ–º–µ —Ç–æ–≥–æ, –∑–∞–º–µ—Ä—è–µ–º –ø–µ—Ä–∏–æ–¥ –∫–æ–ª–µ–±–∞–Ω–∏–π —Å–∏—Å—Ç–µ–º—ã T.
 –°–æ–±—Å—Ç–≤–µ–Ω–Ω–æ, –Ω–∞ —ç—Ç–æ–º –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —á–∞—Å—Ç—å –º–µ—Ç–æ–¥–∞ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è. –ò–∑ –ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞ K 
 —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ü–ò–î-—Ä–µ–≥—É–ª—è—Ç–æ—Ä–∞:


Kn = 0.6 * K
‚Äã
–ê –∏–∑ –Ω–µ–≥–æ –ø–æ–ª—É—á–∞–µ–º –∏ –æ—Å—Ç–∞–ª—å–Ω—ã–µ:

Ki = ( 2 * Kn )‚ÄÖ/‚ÄÖT

Kd = ( Kn * T )‚ÄÖ/‚ÄÖ8

–ú–µ—Ç–æ–¥ –¥–æ–≤–æ–ª—å–Ω–æ –ø—Ä–æ—Å—Ç, –Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –µ–≥–æ –º–æ–∂–Ω–æ –¥–∞–ª–µ–∫–æ –Ω–µ –≤—Å–µ–≥–¥–∞. –ï—Å–ª–∏ —á–µ—Å—Ç–Ω–æ, –º–Ω–µ –µ—â–µ –Ω–∏ —Ä–∞–∑—É –Ω–µ
 –ø—Ä–∏—Ö–æ–¥–∏–ª–æ—Å—å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å —Ä–µ–≥—É–ª—è—Ç–æ—Ä —Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º. –ù–æ —Ç–µ–º –Ω–µ –º–µ–Ω–µ–µ, —ç—Ç–æ—Ç –º–µ—Ç–æ–¥ —è–≤–ª—è–µ—Ç—Å—è –æ—Å–Ω–æ–≤–Ω—ã–º –∏, 
 –ø–æ –±–æ–ª—å—à–æ–º—É —Å—á–µ—Ç—É, –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º —à–∏—Ä–æ–∫–æ –∏–∑–≤–µ—Å—Ç–Ω—ã–º. –ü—Ä–æ—Å—Ç–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –Ω–µ –≤—Å–µ–º –∏ –Ω–µ –≤—Å–µ–≥–¥–∞.

–ß—Ç–æ –∂–µ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ –º–µ—Ç–æ–¥ –¶–∏–≥–ª–µ—Ä–∞-–ù–∏–∫–æ–ª—å—Å–∞ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª? –¢—É—Ç –ø—Ä–∏–¥–µ—Ç –Ω–∞ –ø–æ–º–æ—â—å ‚Äú–∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π‚Äù 
–º–µ—Ç–æ–¥ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ üôÇ

–û–ø—è—Ç—å –∂–µ –æ–±–Ω—É–ª—è–µ–º –≤—Å–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –∏ –Ω–∞—á–∏–Ω–∞–µ–º —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π. –ù–æ —Ç–µ–ø–µ—Ä—å –Ω–µ –∂–¥–µ–º 
–ø–æ—è–≤–ª–µ–Ω–∏—è –∫–æ–ª–µ–±–∞–Ω–∏–π, –∞ –ø—Ä–æ—Å—Ç–æ —Ñ–∏–∫—Å–∏—Ä—É–µ–º –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞ 
(–æ—Ç–ª–∏—á–Ω—ã–º –≤–∞—Ä–∏–∞–Ω—Ç–æ–º –±—É–¥–µ—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –≤–µ–ª–∏—á–∏–Ω—ã, –∫–æ—Ç–æ—Ä—É—é –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å, –¥–ª—è 
–∫–∞–∂–¥–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞). –ï—Å–ª–∏ –≤–∏–¥–∏–º, —á—Ç–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–∏—Å—Ç–µ–º–∞ –æ—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–æ –≤—ã—Ö–æ–¥–∏—Ç –Ω–∞ 
–Ω—É–∂–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç. –°–∏—Å—Ç–µ–º–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç —Å–∏–ª—å–Ω–æ –∫–æ–ª–µ–±–∞—Ç—å—Å—è 
–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –Ω—É–∂–Ω–æ–π –≤–µ–ª–∏—á–∏–Ω—ã? –ó–Ω–∞—á–∏—Ç, –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Å–ª–∏—à–∫–æ–º –≤–µ–ª–∏–∫, —É–º–µ–Ω—å—à–∞–µ–º –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ 
–¥—Ä—É–≥–∏—Ö —Å–æ—Å—Ç–∞–≤–ª—è—é—â–∏—Ö.

–ü–æ–Ω–∏–º–∞—è, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ü–ò–î-—Ä–µ–≥—É–ª—è—Ç–æ—Ä –≤ —Ü–µ–ª–æ–º, –∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—è, –∫–∞–∫ –¥–æ–ª–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–∞—è 
—Å–∏—Å—Ç–µ–º–∞, –º–æ–∂–Ω–æ –¥–æ–≤–æ–ª—å–Ω–æ-—Ç–∞–∫–∏ –±—ã—Å—Ç—Ä–æ –∏ —Ç–æ—á–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã —Ä–µ–≥—É–ª—è—Ç–æ—Ä–∞. –û—Å–æ–±–µ–Ω–Ω–æ, –µ—Å–ª–∏ 
–µ—Å—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ –≤–∏–∑—É–∞–ª—å–Ω–æ —Å–ª–µ–¥–∏—Ç—å –∑–∞ –ø–æ–≤–µ–¥–µ–Ω–∏–µ–º —Å–∏—Å—Ç–µ–º—ã.

–í–æ—Ç –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∞–≤–∏–ª–∞, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –ø–æ–º–æ—á—å –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –ü–ò–î-—Ä–µ–≥—É–ª—è—Ç–æ—Ä–∞:
‚óæ–£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ —É–≤–µ–ª–∏—á–µ–Ω–∏—é –±—ã—Å—Ç—Ä–æ–¥–µ–π—Å—Ç–≤–∏—è, –Ω–æ —Å–Ω–∏–∂–µ–Ω–∏–µ 
—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã.
‚óæ–£–≤–µ–ª–∏—á–µ–Ω–∏–µ –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π —Å–æ—Å—Ç–∞–≤–ª—è—é—â–µ–π —Ç–∞–∫–∂–µ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–º—É —É–≤–µ–ª–∏—á–µ–Ω–∏—é –±—ã—Å—Ç—Ä–æ–¥–µ–π—Å—Ç–≤–∏—è.
‚óæ–î–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —Å–æ—Å—Ç–∞–≤–ª—è—é—â–∞—è –ø—Ä–∏–∑–≤–∞–Ω–∞ —É—Å—Ç—Ä–∞–Ω–∏—Ç—å –∑–∞—Ç—É—Ö–∞—é—â–∏–µ –∫–æ–ª–µ–±–∞–Ω–∏—è, –≤–æ–∑–Ω–∏–∫–∞—é—â–∏–µ –ø—Ä–∏ 
–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —Ç–æ–ª—å–∫–æ –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π —Å–æ—Å—Ç–∞–≤–ª—è—é—â–µ–π.
‚óæ–ò–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω–∞—è —Å–æ—Å—Ç–∞–≤–ª—è—é—â–∞—è –¥–æ–ª–∂–Ω–∞ —É—Å—Ç—Ä–∞–Ω—è—Ç—å –æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ —Ä–∞—Å—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö 
–ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –∏ –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π —Å–æ—Å—Ç–∞–≤–ª—è—é—â–∏—Ö.

–ö—Å—Ç–∞—Ç–∏, —Å—Ç–æ–∏—Ç –¥–æ–±–∞–≤–∏—Ç—å, —á—Ç–æ –Ω–µ –≤—Å–µ–≥–¥–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å–µ —Ç—Ä–∏ —Å–æ—Å—Ç–∞–≤–ª—è—é—â–∏–µ –ü–ò–î-—Ä–µ–≥—É–ª—è—Ç–æ—Ä–∞, 
–ø–æ—Ä–æ–π —Ö–≤–∞—Ç–∞–µ—Ç –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –∏ –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π, –Ω–∞–ø—Ä–∏–º–µ—Ä (–ü–î-—Ä–µ–≥—É–ª—è—Ç–æ—Ä). –í –æ–±—â–µ–º, –≤—Å–µ —Å–≤–æ–¥–∏—Ç—Å—è 
–∫ —Ç–æ–º—É, —á—Ç–æ –¥–ª—è –∫–∞–∂–¥–æ–π —Å–∏—Å—Ç–µ–º—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º —Å–≤–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ 
–ü–ò–î-—Ä–µ–≥—É–ª—è—Ç–æ—Ä–∞.

*/

#include <stdint.h>

class MPid 
{

public:
  MPid() 
  {
    clear();
  }

  MPid( uint16_t kp, uint16_t ki, uint16_t kd, int16_t min, int16_t max )
  {
    configure(kp, ki, kd, min, max);
  }
  
  ~MPid();

public:

  // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã - –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å –≤–µ–¥—É—â–∏–º –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–º
  // –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è (–ø—Ä–µ–¥–≤—ã—á–∏—Å–ª–µ–Ω–∏—è) –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.

  static constexpr int32_t  integ_max   = 0x007FFFFF;   //0x007FFFFF
  static constexpr int32_t  integ_min   = 0xFF800000;   //0xFF800000
  static constexpr int16_t  deriv_max   = 0x7FFF;
  static constexpr int16_t  deriv_min   = 0x8000;

  #ifdef HZ_10
    static constexpr uint8_t  param_shift = 8;
    static constexpr uint8_t  param_bits  = 16;
    static constexpr uint16_t param_max   = (((0x1ULL << param_bits)-1) >> param_shift);              // 0xFF
    static constexpr uint16_t param_mult  = (((0x1ULL << param_bits)) >> (param_bits - param_shift)); // 0x100
    static constexpr uint16_t hz = 10;
  #endif
  #ifdef HZ_250
    static constexpr uint8_t param_shift =  4; //8;
    static constexpr uint8_t param_bits  = 16;
    static constexpr uint16_t param_max  = (((0x1 << param_bits)-1) >> param_shift); 
    static constexpr uint16_t param_mult = (((0x1 << param_bits)) >> (param_bits - param_shift));
    static constexpr uint16_t hz = 250;
  #endif


  void setCoefficients(uint16_t kp, uint16_t ki, uint16_t kd);
  void setOutputRange(int16_t min, int16_t max);
  void clear();
  void configure(uint16_t kp, uint16_t ki, uint16_t kd, int16_t min, int16_t max );
  void replaceConfig(uint16_t kp, uint16_t ki, uint16_t kd, int16_t min, int16_t max);    // moro 
  int16_t step(int16_t sp, int16_t fb);
  
  int16_t getLastSp();
  int32_t getLastErr();

  void setLastSp(int16_t sp);
  void setLastErr(int32_t err);
  
private:
  void setCfgErr(); 

private:
  // Configuration
  uint32_t p, i, d;
  int64_t outMax, outMin; 
  
  // State
  int16_t lastSp;
    int16_t lastOut;
  int64_t sum;
  int32_t lastErr;
  
};

#endif  //!_MPID_H_